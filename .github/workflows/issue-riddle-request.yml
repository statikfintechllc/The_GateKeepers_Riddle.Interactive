name: Issue Riddle Request Handler

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  handle-riddle-request:
    runs-on: ubuntu-latest
    # Only run if issue is labeled with 'enhancement' or 'documentation' or title contains 'riddle'
    if: |
      (contains(github.event.issue.labels.*.name, 'enhancement') || 
       contains(github.event.issue.labels.*.name, 'documentation') ||
       contains(github.event.issue.title, 'Riddle') ||
       contains(github.event.issue.title, 'riddle') ||
       contains(github.event.issue.title, 'poem') ||
       contains(github.event.issue.title, 'Poem'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Assign Copilot to issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add comment confirming the request
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– **Riddle Request Detected!**\n\n' +
                    'GitHub Copilot has been assigned to this issue.\n' +
                    'The Riddle Finder Agent will now process your request and create a new riddle.\n\n' +
                    'Please wait while the automated workflow:\n' +
                    '1. âœ… Finds or generates a new riddle\n' +
                    '2. âœ… Creates the riddle file\n' +
                    '3. âœ… Opens a pull request\n' +
                    '4. âœ… Auto-merges the riddle\n\n' +
                    'This may take a few minutes...'
            });
            
            console.log('âœ… Added comment to issue #' + context.issue.number);
      
      - name: Trigger Riddle Finder Agent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Trigger the riddle-finder-agent workflow
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'riddle-finder-agent.yml',
              ref: 'master',
              inputs: {
                source_type: 'mixed',
                difficulty: 'hard'
              }
            });
            
            console.log('âœ… Triggered Riddle Finder Agent workflow');
            console.log('   Workflow: riddle-finder-agent.yml');
            console.log('   Ref: master');
      
      - name: Update issue status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add a final status comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ”„ **Riddle Finder Agent Activated**\n\n' +
                    'The automated riddle creation workflow has been triggered.\n' +
                    'You can track progress in the [Actions tab](https://github.com/' + 
                    context.repo.owner + '/' + context.repo.repo + '/actions).\n\n' +
                    'A pull request will be created automatically when the riddle is ready.'
            });
            
            console.log('âœ… Updated issue with workflow status');
      
      - name: Summary
        run: |
          echo "âœ… Issue #${{ github.event.issue.number }} processed"
          echo "ðŸ¤– Copilot assigned"
          echo "ðŸ”„ Riddle Finder Agent triggered"
          echo "ðŸ“‹ Status comments added"
