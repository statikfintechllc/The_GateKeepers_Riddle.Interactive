name: Issue Riddle Request Handler

'on':
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  acknowledge-request:
    runs-on: ubuntu-latest
    # Only run if issue title contains riddle/poem (case-insensitive) or has specific labels
    if: |
      (contains(github.event.issue.labels.*.name, 'enhancement') || 
       contains(github.event.issue.labels.*.name, 'documentation') ||
       contains(toLower(github.event.issue.title), 'riddle') ||
       contains(toLower(github.event.issue.title), 'poem'))
    
    steps:
      - name: Acknowledge riddle request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add comment confirming the request
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ü§ñ **Riddle Request Detected!**\n\n' +
                    'The Riddle Finder Agent will now process your request and create a new riddle.\n\n' +
                    'Please wait while the automated workflow:\n' +
                    '1. ‚úÖ Finds or generates a new riddle\n' +
                    '2. ‚úÖ Creates the riddle file\n' +
                    '3. ‚úÖ Opens a pull request\n' +
                    '4. ‚úÖ Auto-merges the riddle\n\n' +
                    '**Estimated time:** 2-5 minutes\n\n' +
                    'You can track progress in the [Actions tab](https://github.com/' + 
                    context.repo.owner + '/' + context.repo.repo + '/actions).'
            });
            
            console.log('‚úÖ Added comment to issue #' + context.issue.number);
  
  # Call the Riddle Finder Agent workflow directly
  call-riddle-finder:
    needs: acknowledge-request
    uses: ./.github/workflows/riddle-finder-agent.yml
    permissions:
      contents: write
      pull-requests: write
    with:
      source_type: 'mixed'
      difficulty: 'hard'
  
  update-issue:
    needs: call-riddle-finder
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Update issue with results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const riddleCreated = '${{ needs.call-riddle-finder.outputs.riddle_created }}';
            const prNumber = '${{ needs.call-riddle-finder.outputs.pr_number }}';
            const riddleTitle = '${{ needs.call-riddle-finder.outputs.riddle_title }}';
            
            let message = '';
            
            if (riddleCreated === 'true' && prNumber) {
              // Use default values if outputs are empty
              const title = riddleTitle || 'New Riddle';
              const pr = prNumber || 'N/A';
              
              message = '‚úÖ **Riddle Successfully Created!**\n\n' +
                       `**Riddle**: ${title}\n` +
                       `**Pull Request**: #${pr}\n\n` +
                       'The riddle has been created and submitted for auto-merge. ' +
                       'Please check the pull request to confirm the merge status.';
            } else if (riddleCreated === 'false') {
              message = '‚ÑπÔ∏è **No New Riddle Created**\n\n' +
                       'The selected riddle may already exist in the system.\n' +
                       'Please try again later for a different riddle.';
            } else {
              message = '‚ö†Ô∏è **Riddle Creation Failed**\n\n' +
                       'There was an issue creating the riddle.\n' +
                       'Please check the [Actions tab](https://github.com/' + 
                       context.repo.owner + '/' + context.repo.repo + '/actions) for details.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            // Close the issue if riddle was created successfully
            if (riddleCreated === 'true') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
              console.log('‚úÖ Issue closed successfully');
            }
