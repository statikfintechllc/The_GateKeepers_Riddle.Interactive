name: Daily Riddle Submission

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  find-and-submit-riddle:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install axios cheerio @anthropic-ai/sdk
      
      - name: Find and process riddle
        id: riddle
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const https = require('https');
          
          // Riddle sources to search
          const riddleSources = [
            'https://www.riddles.com/hardest',
            'https://parade.com/947956/parade/riddles/',
            'https://www.prodigygame.com/main-en/blog/riddles-for-kids/'
          ];
          
          // Function to fetch content from URL
          function fetchURL(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', reject);
            });
          }
          
          // Extract riddles from HTML (simplified - would need proper parsing in production)
          function extractRiddles(html) {
            // This is a simplified extraction - in production you'd use cheerio or similar
            const riddles = [];
            const riddlePattern = /<div class="riddle">(.*?)<\/div>/gs;
            const matches = html.matchAll(riddlePattern);
            for (const match of matches) {
              riddles.push(match[1]);
            }
            return riddles;
          }
          
          // Generate riddle ID from title
          function generateId(title) {
            return title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
          }
          
          // Check if riddle already exists
          function riddleExists(id) {
            const riddlesDir = path.join(process.cwd(), 'system', 'riddles');
            const riddleFile = path.join(riddlesDir, `${id}.riddle.js`);
            return fs.existsSync(riddleFile);
          }
          
          // Create riddle file content
          function createRiddleContent(riddle) {
            return `/**
   * ${riddle.title}
   * Automatically generated by the Daily Riddle Submission workflow
   * Source: ${riddle.source}
   * Date: ${new Date().toISOString().split('T')[0]}
   */

  export const riddle = {
      id: '${riddle.id}',
      title: '${riddle.title}',
      text: \`${riddle.text}\`,
      correctAnswers: ${JSON.stringify(riddle.correctAnswers, null, 4)},
      closeAnswers: ${JSON.stringify(riddle.closeAnswers, null, 4)},
      hints: ${JSON.stringify(riddle.hints, null, 4)},
      wrongAnswerFeedback: '${riddle.wrongAnswerFeedback}',
      closeAnswerFeedback: '${riddle.closeAnswerFeedback}',
      explanation: '${riddle.explanation}',
      answer: '${riddle.answer}'
  };
  `;
          }
          
          // Main logic
          async function main() {
            console.log('üîç Searching for challenging riddles...');
            
            // For this example, we'll create a sample riddle
            // In production, you would scrape from the sources above
            const sampleRiddle = {
              title: 'The Time Travelers Dilemma',
              text: `I am always hungry and must always be fed,
  The finger I touch will soon turn red.
  What am I?`,
              answer: 'Fire',
              source: 'Classic Riddles Collection',
              correctAnswers: ['fire', 'flame', 'blaze'],
              closeAnswers: ['heat', 'burn', 'hot', 'ember', 'spark'],
              hints: [
                'Think about something that consumes',
                'It\'s dangerous to touch',
                'It turns things red or black',
                'It needs fuel to survive',
                'Ancient humans discovered and controlled it',
                'It\'s one of the four classical elements'
              ],
              wrongAnswerFeedback: 'Not quite. Think about something that must constantly consume to exist.',
              closeAnswerFeedback: 'You\'re getting warm! Think about the source of that heat.',
              explanation: 'Fire must constantly consume fuel to exist, and touching it causes burns that turn fingers red.'
            };
            
            const riddleId = generateId(sampleRiddle.title);
            sampleRiddle.id = riddleId;
            
            // Check if this riddle already exists
            if (riddleExists(riddleId)) {
              console.log(`‚è≠Ô∏è  Riddle "${sampleRiddle.title}" already exists, skipping...`);
              process.exit(0);
            }
            
            console.log(`‚úÖ Found new riddle: "${sampleRiddle.title}"`);
            
            // Create riddle file
            const riddleContent = createRiddleContent(sampleRiddle);
            const riddleFile = path.join(process.cwd(), 'system', 'riddles', `${riddleId}.riddle.js`);
            fs.writeFileSync(riddleFile, riddleContent);
            
            console.log(`üìù Created riddle file: ${riddleFile}`);
            
            // Output for GitHub Actions
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `riddle_id=${riddleId}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `riddle_title=${sampleRiddle.title}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `riddle_created=true\n`);
          }
          
          main().catch(error => {
            console.error('‚ùå Error:', error);
            process.exit(1);
          });
          EOF
      
      - name: Update riddles.js registry
        if: steps.riddle.outputs.riddle_created == 'true'
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const riddleId = process.env.RIDDLE_ID;
          const riddlesFile = path.join(process.cwd(), 'system', 'riddles', 'riddles.js');
          
          let content = fs.readFileSync(riddlesFile, 'utf8');
          
          // Add import statement
          const importLine = `import { riddle as ${riddleId.replace(/-/g, '_')}Riddle } from './${riddleId}.riddle.js';`;
          const importInsertPos = content.lastIndexOf('import');
          const importInsertEnd = content.indexOf(';', importInsertPos) + 1;
          content = content.slice(0, importInsertEnd) + '\n' + importLine + content.slice(importInsertEnd);
          
          // Add to riddles array
          const arrayMatch = content.match(/export const riddles = \[([\s\S]*?)\];/);
          if (arrayMatch) {
            const arrayContent = arrayMatch[1].trim();
            const newArrayContent = arrayContent ? 
              `${arrayContent},\n    ${riddleId.replace(/-/g, '_')}Riddle` :
              `\n    ${riddleId.replace(/-/g, '_')}Riddle\n`;
            content = content.replace(
              /export const riddles = \[([\s\S]*?)\];/,
              `export const riddles = [${newArrayContent}];`
            );
          }
          
          fs.writeFileSync(riddlesFile, content);
          console.log('‚úÖ Updated riddles.js registry');
          EOF
        env:
          RIDDLE_ID: ${{ steps.riddle.outputs.riddle_id }}
      
      - name: Create Pull Request
        if: steps.riddle.outputs.riddle_created == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add new riddle: ${{ steps.riddle.outputs.riddle_title }}
            
            Automatically discovered and submitted by Daily Riddle Submission workflow.
          branch: riddle/${{ steps.riddle.outputs.riddle_id }}
          delete-branch: true
          title: 'üß© New Riddle: ${{ steps.riddle.outputs.riddle_title }}'
          body: |
            ## üéØ Automated Riddle Submission
            
            This PR adds a new riddle discovered by the automated riddle submission workflow.
            
            ### Riddle Details
            - **Title**: ${{ steps.riddle.outputs.riddle_title }}
            - **ID**: `${{ steps.riddle.outputs.riddle_id }}`
            - **File**: `system/riddles/${{ steps.riddle.outputs.riddle_id }}.riddle.js`
            
            ### What's Changed
            - ‚úÖ New riddle file created with all required fields
            - ‚úÖ Registry updated in `system/riddles/riddles.js`
            - ‚úÖ Follows riddle template schema
            
            ### Review Checklist
            - [ ] Riddle text is clear and well-formatted
            - [ ] Correct answers are comprehensive
            - [ ] Close answers are appropriate
            - [ ] Hints progress from vague to specific
            - [ ] Feedback messages are helpful
            - [ ] Explanation makes sense
            - [ ] No duplicates of existing riddles
            
            ---
            
            ü§ñ *This PR was created automatically by the [Daily Riddle Submission workflow](.github/workflows/daily-riddle-submission.yml)*
          labels: |
            automated
            riddle
            enhancement
          reviewers: statikfintechllc
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.riddle.outputs.riddle_created }}" == "true" ]; then
            echo "‚úÖ Successfully submitted new riddle: ${{ steps.riddle.outputs.riddle_title }}"
            echo "üìã Pull request created for review"
          else
            echo "‚ÑπÔ∏è  No new riddles to submit today"
          fi
